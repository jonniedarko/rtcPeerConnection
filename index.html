<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Peer</title>
</head>
<body>
	<video id="localVideo" autoplay></video>
  	<video id="remoteVideo" autoplay></video>
  	<div>
	    <button id="startButton">Start</button>
	    <button id="callButton">Call</button>
	    <button id="hangupButton">Hang Up</button>
  </div>

  <script>
  	var localStream, localPeerConnection, remotePeerConnection;

  	var localVideo = document.getElementById('localVideo'),
  		remoteVideo = document.getElementById('remoteVideo');
  	//Trace Action listeners ....
  	//
  	var startButton = document.getElementById('startButton'),
  		callButton = document.getElementById('callButton'),
  		hangUpButton = document.getElementById('hangUp');
  	startButton.disabled = false;
  	//cannot call untill start is pressed
	callButton.disabled = true;
	//cannot hang up unless in call
	hangupButton.disabled = true;
	startButton.onclick = start;
	callButton.onclick = call;
	hangupButton.onclick = hangUp;

	function onSuccessfullConnection(mediaStream){
		//creates a DOMString containing a URL repersenting the mediaStream
		localVideo.src = URL.createObjectURL(mediaStream);
		localStream = mediaStream;
		callButton.disabled = false;
	}
	function onConnectionError(error){
		console.log('Error', error);
	}
	function start(){
		startButton.disabled = true;
		navigator.getUserMedia =  navigator.getUserMedia || navigator.mozGetUserMedia || navigator.webkitGetUserMedia || null;

		if(navigator.getUserMedia !== null){
			navigator.getUserMedia({
				video : true
			},onSuccessfullConnection, onConnectionError)
		}
	}//End: start

	function gotLocalIce(event){
		if(event.candidate){
			remotePeerConnection.addIceCandidate(new RTCIceCandidate(event.candidate));
			console.log("Local ICE candidate:" + event.candidate.candidate);
		}
	}

	function gotRemoteIce(event){
		if(event.candidate){
			localPeerConnection.addIceCandidate(new RTCIceCandidate(event.candidate));
			console.log("Remote ICE candidate:" + event.candidate.candidate);
		}
	}

	function gotRemoteStream(event){
		remoteVideo.src = URL.createObjectURL(event.stream);
		console.log('Remote Stream Recieved');
	}

	function getLocalDescription(description){
		localPeerConnection.setLocalDescription(description);
		console.log("Offer from localPeerConnection:" + description.sdp);
		remotePeerConnection.setRemoteDescription(description);
		remotePeerConnection.createAnswer(gotRemoteDescription);
	}

	function gotRemoteDescription(description){
	  remotePeerConnection.setLocalDescription(description);
	  console.log("Answer from remotePeerConnection:" + description.sdp);
	  localPeerConnection.setRemoteDescription(description);
	}

	function call(){
		callButton.disabled = true;
  		hangupButton.disabled = false;

  		if(localStream.getVideoTracks().length > 0){
  			console.log('using Video Device:', localStream.getVideoTracks()[0].label);
  		}
  		var servers = null;
  		var PeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection || null;
  			if(PeerConnection !== null){
  				localPeerConnection = new PeerConnection(servers);
  				//localPeerConnection = new RTCPeerConnection(servers);
  				localPeerConnection.onicecandidate = gotLocalIce;

  				remotePeerConnection = new PeerConnection(servers);
  				remotePeerConnection.onicecandidate = gotRemoteIce;
  				remotePeerConnection.onaddstream = gotRemoteStream;

  				localPeerConnection.addStream(localStream);
  				localPeerConnection.createOffer(getLocalDescription);

  			}
	}//End: call

	function hangUp(){
		console.log('Hanging up');
		localPeerConnection.close();
		remotePeerConnection.close();
		localPeerConnection = null;
		remotePeerConnection = null;
		hangupButton.disabled = true;
		callButton.disabled = false;
	}

  </script>
</body>
</html>
